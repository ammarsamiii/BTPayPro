// Test if script is loaded
console.log('Admin users script loaded');

document.addEventListener('DOMContentLoaded', async function () {
    console.log('DOM loaded, initializing admin users page');

    // Protect this page - redirect to login if not authenticated
    protectPage();

    // Update user name display
    const userNameElement = document.getElementById('userNameDisplay');
    if (userNameElement) {
        userNameElement.textContent = getUserName();
    }

    // Update profile photo
    await fetchProfilePhoto();
    updateTopbarProfilePhoto();

    // Load statistics data
    console.log('Loading statistics data');
    await updateStatisticsFromAPI();

    // Load users data
    console.log('Loading all users data');
    await loadAllUsers();

    // Add event listener for the add user form
    const addUserForm = document.getElementById('addUserForm');
    if (addUserForm) {
        addUserForm.addEventListener('submit', handleAddUserFormSubmit);
    }
});

// Toggle the add user form visibility
function toggleAddUserForm() {
    const formContainer = document.getElementById('addUserFormContainer');
    if (formContainer) {
        if (formContainer.style.display === 'none') {
            formContainer.style.display = 'block';
        } else {
            formContainer.style.display = 'none';
        }
    }
}

// Handle add user form submission
async function handleAddUserFormSubmit(event) {
    event.preventDefault();

    // Get form values
    const username = document.getElementById('username').value;
    const email = document.getElementById('email').value;
    const firstName = document.getElementById('firstName').value;
    const lastName = document.getElementById('lastName').value;
    const userType = document.getElementById('userType').value;
    const password = document.getElementById('password').value;
    const repeatPassword = document.getElementById('repeatPassword').value;

    // Basic validation
    if (!username || !email || !firstName || !lastName || !userType || !password || !repeatPassword) {
        alert('Please fill in all fields');
        return;
    }

    if (password !== repeatPassword) {
        alert('Passwords do not match');
        return;
    }

    // Create user data object - using the structure expected by the AuthController
    const userData = {
        idUser: "", // Will be generated by the backend
        userType: userType,
        phoneNumber: "",
        email: email,
        passwordHash: password,
        firstName: firstName,
        lastName: lastName,
        projectName: "",
        profilePhotoUrl: ""
    };

    try {
        // Make API call to create user using the register endpoint
        const response = await authenticatedFetch(`${AppConfig.API_BASE_URL}/Auth/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        });

        if (response && response.ok) {
            alert('User created successfully');
            // Reset form
            document.getElementById('addUserForm').reset();
            // Hide form
            toggleAddUserForm();
            // Refresh user list
            await loadAllUsers();
            // Refresh statistics
            await updateStatisticsFromAPI();
        } else {
            const errorText = await response.text();
            console.error('Error creating user:', errorText);
            alert('Error creating user: ' + errorText);
        }
    } catch (error) {
        console.error('Error creating user:', error);
        alert('Error creating user: ' + error.message);
    }
}

// Load all users from API - using the same approach as dashboard-admin
async function loadAllUsers() {
    try {
        const response = await authenticatedFetch(`${AppConfig.API_BASE_URL}/User`);

        if (response && response.ok) {
            const users = await response.json();

            // Log the raw users data for debugging
            console.log('Raw users data from API:', users);

            // Display all users in table
            await displayUsers(users);
        } else {
            // Show error state when users cannot be loaded
            const tbody = document.getElementById('usersTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">User data not available</td></tr>';
            }
        }
    } catch (error) {
        console.error('Error loading users:', error);
        // Show error state when users cannot be loaded
        const tbody = document.getElementById('usersTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">User data not available</td></tr>';
        }
    }
}

// Display users in table - using the same approach as dashboard-admin
async function displayUsers(users) {
    const tbody = document.getElementById('usersTableBody');

    // Always clear the table first
    if (!tbody) {
        console.error('Could not find usersTableBody element');
        return;
    }

    // Check if users array is empty or invalid
    if (!users || !Array.isArray(users) || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No users found in database</td></tr>';
        return;
    }

    // Generate table rows
    const htmlPromises = users.map(async user => {
        // Log each user for debugging
        console.log('Processing user:', user);

        // Extract available properties from the initial API call
        const email = user.email || 'N/A';
        const userId = user.userId || user.UserId || user.id || 'N/A';
        const username = user.username || '';

        // Initialize firstName and lastName
        let firstName = '';
        let lastName = '';
        let userType = '';

        // Try to get firstName and lastName from the user object
        firstName = user.firstName || user.FirstName || user.firstname || '';
        lastName = user.lastName || user.LastName || user.lastname || '';
        userType = user.userType || user.UserType || user.type || user.Type || '';

        // If we don't have firstName/lastName or userType, fetch detailed profile data
        if ((!firstName && !lastName) || !userType) {
            try {
                console.log('Fetching detailed profile for user:', userId);
                const profileResponse = await authenticatedFetch(`${AppConfig.API_BASE_URL}/Profile/${userId}`);
                if (profileResponse && profileResponse.ok) {
                    const profile = await profileResponse.json();
                    console.log('Profile data for user', userId, ':', profile);

                    // Extract firstName and lastName from profile if not already available
                    if (!firstName) firstName = profile.firstName || profile.FirstName || profile.firstname || '';
                    if (!lastName) lastName = profile.lastName || profile.LastName || profile.lastname || '';
                    if (!userType) userType = profile.userType || profile.UserType || profile.type || profile.Type || '';
                }
            } catch (profileError) {
                console.error('Error fetching profile for user', userId, ':', profileError);
            }
        }

        // If firstName and lastName are still empty, use username as firstName
        if (!firstName && !lastName) {
            if (username) {
                // Use username as firstName
                firstName = username;
                lastName = '';
            } else if (email && email !== 'N/A') {
                // Extract name from email (before @) if no username
                const emailName = email.split('@')[0];
                if (emailName.includes('.')) {
                    const parts = emailName.split('.');
                    firstName = parts[0] || '';
                    lastName = parts[1] || '';
                    // Capitalize first letter
                    firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1);
                    lastName = lastName.charAt(0).toUpperCase() + lastName.slice(1);
                } else if (emailName.includes('_')) {
                    const parts = emailName.split('_');
                    firstName = parts[0] || '';
                    lastName = parts.slice(1).join(' ') || '';
                    // Capitalize first letter
                    firstName = firstName.charAt(0).toUpperCase() + firstName.slice(1);
                    lastName = lastName.charAt(0).toUpperCase() + lastName.slice(1);
                } else {
                    firstName = emailName.charAt(0).toUpperCase() + emailName.slice(1);
                    lastName = '';
                }
            }
        }

        // If userType is still empty, determine based on email patterns
        if (!userType) {
            if (email.includes('admin')) {
                userType = 'Admin';
            } else if (email.includes('vendor') || email.includes('merchant')) {
                userType = 'Merchant';
            } else {
                userType = 'Client';
            }
        }

        // Format user type badge
        const typeMap = {
            'Client': 'primary',
            'Merchant': 'warning',
            'Admin': 'danger'
        };
        const typeClass = typeMap[userType] || 'secondary';
        const typeBadge = `<span class="badge badge-${typeClass}">${userType}</span>`;

        return `
        <tr id="user-row-${userId}">
            <td>${lastName}</td>
            <td>${firstName}</td>
            <td>${email}</td>
            <td>${typeBadge}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deleteUser('${userId}', this)">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </td>
        </tr>`;
    });

    // Wait for all profile fetches to complete
    const htmlArray = await Promise.all(htmlPromises);
    const html = htmlArray.join('');

    tbody.innerHTML = html;
}

// Delete user from the block (client-side only)
function deleteUser(userId, buttonElement) {
    if (!userId || userId === 'N/A') {
        console.error('No user ID provided for deletion');
        alert('No user ID provided for deletion');
        return;
    }

    // Confirm deletion
    if (!confirm('Are you sure you want to delete this user from the list?')) {
        return;
    }

    try {
        // Remove the row from the table
        const row = buttonElement.closest('tr');
        if (row) {
            row.remove();
            console.log('User row removed successfully for user ID:', userId);
            alert('User removed from the list successfully');

            // Refresh statistics since we've removed a user
            updateStatisticsFromAPI();
        } else {
            console.error('Could not find row to remove for user ID:', userId);
            alert('Could not find user row to remove');
        }
    } catch (error) {
        console.error('Error removing user row:', error);
        alert(`Error removing user: ${error.message}`);
    }
}

// Update statistics by fetching data directly from the API
async function updateStatisticsFromAPI() {
    try {
        const response = await authenticatedFetch(`${AppConfig.API_BASE_URL}/User`);

        if (response && response.ok) {
            const users = await response.json();

            // Update statistics directly from the fetched data
            updateStatistics(users);
        } else {
            resetStatistics();
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
        resetStatistics();
    }
}

// Reset statistics to zero
function resetStatistics() {
    document.getElementById('totalCount').textContent = '0';
    document.getElementById('clientCount').textContent = '0';
    document.getElementById('merchantCount').textContent = '0';
    document.getElementById('adminCount').textContent = '0';
}

// Update statistics
function updateStatistics(users) {
    const totalUsers = users.length;
    // Count user types based on email patterns since we don't have explicit userType
    const admins = users.filter(u => (u.email || '').includes('admin')).length;
    const merchants = users.filter(u => (u.email || '').includes('vendor') || (u.email || '').includes('merchant')).length;
    const clients = totalUsers - admins - merchants;

    document.getElementById('totalCount').textContent = totalUsers;
    document.getElementById('clientCount').textContent = clients;
    document.getElementById('merchantCount').textContent = merchants;
    document.getElementById('adminCount').textContent = admins;
}

// Make functions globally accessible
window.updateStatisticsFromAPI = updateStatisticsFromAPI;
window.loadAllUsers = loadAllUsers;
window.deleteUser = deleteUser;
window.toggleAddUserForm = toggleAddUserForm;
window.handleAddUserFormSubmit = handleAddUserFormSubmit;